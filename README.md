# EmojiHub — Flutter App + ASP.NET Web API (Emoji Search + “Prediction of the Day”)

## 1) Краткое описание проекта

**EmojiHub** — учебный проект из двух частей:

- **Flutter-приложение** (Android/Web):

  1. **Search** — поиск эмодзи по имени, сортировка (по алфавиту / по категории), фильтр по категории.
  2. **Prediction of the day** — по нажатию кнопки приложение получает от бэка **3 emoji “предсказания дня”**.

- **ASP.NET Web API**:
  - Проксирует данные из источника эмодзи (например, EmojiHub API / ваш источник эмодзи).
  - Для “предсказания дня” вызывает **LLM через OpenRouter** и **кэширует результат на 24 часа**, чтобы не расходовать лимиты и обеспечить стабильность.

---

## 2) Инструкции по установке и запуску

### Требования

- .NET SDK 8.0
- Flutter SDK
- OpenRouter API Key

---

### 2.1 Запуск бэка (ASP.NET)

1. Установите ключ OpenRouter и базовый URL в appsettings.json:
2. Запустите API:

```bash
dotnet run
```

По умолчанию бэк будет доступен по адресу (пример):  
`http://localhost:5258`

> Если используете Swagger:  
> `http://localhost:7131/swagger`

---

### 2.2 Запуск Flutter приложения

1. Перейдите в папку приложения:

```bash
cd mobile
```

2. Установите зависимости:

```bash
flutter pub get
```

3. Сгенерируйте код моделей / retrofit:

```bash
dart run build_runner build --delete-conflicting-outputs
```
4. Замените на ваш api хост в ApiConfig

5. Запуск на Android emulator (host machine):

```bash
flutter run
```

Запуск на Web:

```bash
flutter run -d chrome
```

---

## 3) Описание процесса проектирования и разработки

### Этапы

1. **Проектирование API контрактов**

   - `/api/emojis` — поиск + сортировка + фильтрация + пагинация
   - `/api/categories` — список категорий
   - `/api/suggestions?topic=YYYY-MM-DD` — 3 emoji “предсказания дня”

2. **Разделение ответственности**

   - Flutter: UI/UX, управление состоянием, отображение данных
   - Backend: интеграции (Emoji source + LLM), нормализация данных, кеширование

3. **Разработка**
   - Сначала Search-page (end-to-end)
   - Затем Suggestion-page + LLM интеграция + кэш на 24 часа

---

## 4) Информация об уникальных подходах или методологиях

### 4.1 “Prediction of the day” с TTL 24 часа

- Клиент формирует `topic` как **текущую дату** `YYYY-MM-DD`.
- Бэк кэширует результат по ключу `topic` на 24 часа.
- Это уменьшает расходы и стабилизирует UX (одинаковое предсказание на день).

### 4.2 BLoC (flutter_bloc)

- Применён **BLoC** для предсказуемого управления состоянием:
  - **SearchBloc**: debounce запросов, пагинация, сортировка/фильтры
  - **SuggestBloc**: управление состояниями загрузки/ошибок/данных

### 4.3 Генерация кода

- `json_serializable` — автоген JSON (модели)
- `retrofit_generator` — автоген API клиента поверх Dio

---

## 5) Обсуждение компромиссов, принятых во время разработки

### 5.1 JSON mode (response_format) vs “JSON via prompt”

- Некоторые бесплатные модели (например, `gemma-3-4b-it:free`) могут **не поддерживать JSON mode** (`response_format`), поэтому используется более простой подход:
  - просим JSON строго текстом (prompt)
  - если JSON не распарсился — возвращаем дефолтный результат

**Компромисс:** меньше гарантий идеального формата, но проще и работает на free-моделях.

### 5.2 Кэш в памяти (IMemoryCache) vs Redis/DB

- Для MVP использован `IMemoryCache` (быстро и просто).

**Компромисс:** кэш сбрасывается при рестарте приложения.

### 5.3 “Открытый” endpoint vs защита ключом

- Для MVP endpoint может быть открыт, но это может сожрать запросы в платный Api.
- Для дальнейшего улучшения рекомендуется `X-API-KEY` или JWT.

---

## 6) Описание известных ошибок или проблем в приложении

1. **Некоторые модели не поддерживают `response_format` (JSON mode)**

   - Решение: используем “JSON via prompt” + fallback response.

2. **Эмодзи могут не отображаться, если поле emoji не вычислено**

   - Если источник возвращает HTML entities (`htmlCode`), необходимо декодировать их на бэке, иначе UI покажет только текстовые поля без emoji.

3. **CORS для Web**
   - Для Flutter Web требуется настроенный CORS policy на ASP.NET.

---

## 7) Объясните почему выбрали этот технический стэк

### Flutter

- Один код для Android/Web
- Быстрая разработка UI
- Удобная архитектура (BLoC) и масштабирование

### BLoC (flutter_bloc)

- Предсказуемость состояния
- Хорошо подходит для:
  - debounce поиска
  - пагинации
  - обработки ошибок и загрузки

### Dio + Retrofit (автоген)

- Dio: гибкий HTTP клиент (таймауты, интерцепторы, логирование)
- Retrofit: минимизирует “ручной” код API клиента, снижает риск ошибок

### ASP.NET Web API

- Быстрая разработка REST API
- Удобная интеграция через HttpClientFactory
- Легко добавлять кэширование и middleware (логирование, rate limit, auth)

### OpenRouter

- Единый шлюз к множеству LLM
- Есть free tier модели
- OpenAI-compatible API упрощает интеграцию

---

## 8) Roadmap (опционально)

- Добавить `X-API-KEY` или JWT для защиты endpoint
- Улучшить “валидатор emoji” (строго 3 эмодзи, no-text)
- UI: better ui
